<!DOCTYPE html>
<html>
    <head>
        <title> Arkanoid </title>

        <link href="https://fonts.cdnfonts.com/css/common-pixel" rel="stylesheet">

        <style>
            /*ESTILOS APLICADOS AL CONTENIDO WEB*/

            /*Letra pixel importada*/
            @import url('https://fonts.cdnfonts.com/css/common-pixel');

            body {
                background-color: black;
            }

            p {
                color: white;
                font-family: 'Common Pixel', sans-serif;
                display: inline-block;
            }

            div{
                width: 600px;
                height: 800px;
                margin: 0 auto;
            }

            canvas {
                background-color: white;
            }
        </style>
    </head>
    <body>
        <!--CONTENIDO WEB-->
        <div>
            <span style="line-height: 0px;">
                <p id="parrafoJugador">PLAYER 1</p>
                <p style="float:right">HIGH SCORE</p>
                <br>
                <p id="parrafoPuntos"></p>
                <p id="parrafoHighScore" style="float:right"></p>
            </span>
            <canvas id="lienzo" width="600" height="600"></canvas>

            <p align="center" style="display:block">Sebasti√°n Loges de Faria (Y8469372G) <br> y <br> Carlos Santayana Vicente (02583832N). <br> Fecha de Entrega: 15/01/2023</p>
        </div>

        <!--JAVASCRIPT-->
        <script>
            //VARIABLES DE ELEMENTOS HTML
            var canvas = document.getElementById("lienzo");
            var contexto = canvas.getContext("2d");

            var parrafoJugador = document.getElementById("parrafoJugador");
            var parrafoPuntos = document.getElementById("parrafoPuntos");
            var parrafoHighScore = document.getElementById("parrafoHighScore");

            //IMAGENES
            var spriteFondo = document.createElement("img");
            spriteFondo.src = "./fondo.png";

            var spriteBordeIzquierdo = document.createElement("img");
            spriteBordeIzquierdo.src = "./borde_Izquierdo.png";

            var spriteBordeDerecho = document.createElement("img");
            spriteBordeDerecho.src = "./borde_Derecho.png";

            var spriteBordeSuperior = document.createElement("img");
            spriteBordeSuperior.src = "./borde_Arriba.png";

            var spritePelota = document.createElement("img");
            spritePelota.src = "./pelota.png";

            var spriteRaqueta = document.createElement("img");
            spriteRaqueta.src = "./raqueta.png";
            
            window.onload = function(){
                //////////////////////MANEJADORES DE EVENTOS////////////////////////

                window.addEventListener("mousemove", manejaRaton, false);
                window.addEventListener("click", manejaRaton, false);

                //////////////////////CLASES////////////////////////

                //CLASE RAQUETA
                function raqueta(xP, yP){
                    this.x = xP;
                    this.y = yP;
                    this.vidas = 3;
                    this.ancho = 66;
                    this.alto = 20;

                    this.dibujarRaqueta = function(){
                        contexto.drawImage(spriteRaqueta, this.x, this.y, this.ancho, this.alto);
                    }

                    this.dibujarVidas = function(){
                        var x = 25;
                        for(var i=0;i<this.vidas;++i){
                            contexto.drawImage(spriteRaqueta,x,580,33,10);
                            x+=40;
                        }
                    }

                    this.estaViva=function(){
                        if(this.vidas==-1){
                            var scoreFinal = score;
                            contexto.fillStyle="white";
                            contexto.font="30px Common Pixel";
                            contexto.fillText("GAME OVER", 200, 270);
                            contexto.fillText("SCORE: " + scoreFinal,200,310);
                            contexto.fillStyle="black";
                            reiniciando = true;
                            reiniciarJuego();
                        }
                    }
                }

                //CLASE BLOQUE
                function bloque(xP, yP, colorP, estadoP, vidaP=1){
                    this.x = xP;
                    this.y = yP;
                    this.color = colorP;
                    this.estado = estadoP;
                    this.vida = vidaP;
                    this.ancho = 43.74;
                    this.alto = 20;

                    this.dibujarBloque = function(){
                        if(this.estado!=false){
                            contexto.fillStyle = this.color;
                            contexto.lineWidth = 2;
                            contexto.fillRect(this.x, this.y, this.ancho, this.alto);
                            contexto.strokeRect(this.x, this.y, this.ancho, this.alto);
                        }
                    }
                }

                function pelota(xP,yP){
                    this.x = xP;
                    this.y = yP;
                    this.ancho = 12;
                    this.alto = 12;
                    this.velocidadX = 1;
                    this.velocidadY = 1;

                    this.abajo = false;
                    this.derecha = true;

                    this.dibujarPelota = function(){
                        contexto.drawImage(spritePelota,this.x,this.y,this.ancho,this.alto);
                    }

                    this.moverPelota = function(){
                        //MOVIMIENTO EN EL EJE Y
                        if(!this.abajo&&this.y>=15.66){
                            this.y-=this.velocidadY;
                        }else if(!this.abajo&&this.y<15.66){
                            this.abajo = true;
                            this.y+=this.velocidadY;
                        }else if(this.abajo&&this.y<=624){
                            this.y+=this.velocidadY;
                        }else if(this.abajo&&this.y>624){
                            this.abajo = false;
                            this.y-=this.velocidadY;
                        }

                        //MOVIMIENTO EN EL EJE X
                        if(!this.derecha&&this.x>=15.66){
                            this.x-=this.velocidadX;
                        }else if(!this.derecha&&this.x<15.66){
                            this.derecha = true;
                            this.x+=this.velocidadX;
                        }else if(this.derecha&&this.x<=572.34){
                            this.x+=this.velocidadX;
                        }else if(this.derecha&&this.x>572.34){
                            this.derecha = false;
                            this.x-=this.velocidadX;
                        }
                    }

                    this.detectaColisiones = function(){
                        if (this.x < miRaqueta.x + miRaqueta.ancho && this.x + this.ancho > miRaqueta.x && this.y < miRaqueta.y + miRaqueta.alto && this.alto + this.y > miRaqueta.y){ 
                            this.abajo = false;
                            if((this.x+6)<(miRaqueta.x+33)){
                                this.derecha = false;
                            }else{
                                this.derecha = true;
                            }
                        }

                        for(var i=0;i<6;++i){  
                            for(var j=0;j<13;++j){
                                if (this.x < bloques[i][j].x + bloques[i][j].ancho && this.x + this.ancho > bloques[i][j].x && this.y < bloques[i][j].y + bloques[i][j].alto && this.alto + this.y > bloques[i][j].y){
                                    var centroPelotaX = this.x + this.ancho/2;
                                    var centroPelotaY = this.y + this.alto/2;

                                    if(bloques[i][j].color == "red" && bloques[i][j].estado==true){
                                        score+=90;
                                    }else if(bloques[i][j].color == "gray" && bloques[i][j].estado==true && bloques[i][j].vida == 1){
                                        score+=50;
                                    }else if(bloques[i][j].color == "lime" && bloques[i][j].estado==true){
                                        score+=80;
                                    }else if(bloques[i][j].color == "blue" && bloques[i][j].estado==true){
                                        score+=100;
                                    }else if(bloques[i][j].color == "DeepPink" && bloques[i][j].estado==true){
                                        score+=110;
                                    }else if(bloques[i][j].color == "yellow" && bloques[i][j].estado==true){
                                        score+=120;
                                    }

                                    if(bloques[i][j].y + bloques[i][j].alto < centroPelotaY && bloques[i][j].estado==true){
                                        this.abajo = true;
                                        if(this.velocidadY<8){
                                            this.velocidadY+=0.5;
                                        }else{
                                            this.velocidadY = 8;
                                        }
                                    }else if(bloques[i][j].y > centroPelotaY && bloques[i][j].estado==true){
                                        this.abajo = false;
                                        if(this.velocidadY<8){
                                            this.velocidadY+=0.5;
                                        }else{
                                            this.velocidadY = 8;
                                        }
                                    }else if(bloques[i][j].x > centroPelotaX && bloques[i][j].estado==true){
                                        this.derecha = false;
                                        if(this.velocidadX<8){
                                            this.velocidadX+=0.5;
                                        }else{
                                            this.velocidadX = 8;
                                        }
                                    }else if(bloques[i][j].x + bloques[i][j].ancho < centroPelotaX && bloques[i][j].estado==true){
                                        this.derecha = true;
                                        if(this.velocidadX<8){
                                            this.velocidadY+=0.5;
                                        }else{
                                            this.velocidadX = 8;
                                        }
                                    }

                                    bloques[i][j].vida -= 1;

                                    if(bloques[i][j].vida==0){
                                        bloques[i][j].estado = false;
                                    }
                                }
                            }
                        }

                        if(score>highScore){
                            highScore = score;
                        }

                        parrafoPuntos.innerHTML = score;
                        parrafoHighScore.innerHTML = highScore;
                    }

                    this.estaFuera = function(){
                        if(this.y>612){
                            start = false;
                            this.derecha = true;
                            this.x = 294;
                            this.y = 512;
                            miRaqueta.x = 267;
                            miRaqueta.y = 525;
                            miRaqueta.vidas-=1;
                            this.velocidadX = 1;
                            this.velocidadY = 1;
                        }
                    }
                }


                ///////////////////////FUNCIONES///////////////////////

                function manejaRaton(e){
                    const canvasBorder = canvas.getBoundingClientRect();
                    var canvasCoordX = e.pageX - canvasBorder.left;

                    switch(e.type){
                        case "mousemove":
                            if(canvasCoordX<48.66){
                                miRaqueta.x = 15.66;
                                if(!start){
                                    miPelota.x = 42.66;
                                }
                            }else if(canvasCoordX>551.34){
                                miRaqueta.x = 518.34;
                                if(!start){
                                    miPelota.x = 545.34;
                                }
                            }else{
                                miRaqueta.x = canvasCoordX - 33;
                                if(!start){
                                    miPelota.x = miRaqueta.x + 27;
                                }
                            }
                            break;
                        case "click":
                            if (e.button == 0){
                                start = true;
                                insertCoin = false;
                            }
                            break;
                    }
                }

                function redibuja(){
                    contexto.clearRect(0, 0, 600, 600);
                    contexto.drawImage(spriteFondo, 0, 0, 600, 600);
                    contexto.drawImage(spriteBordeIzquierdo, 0, 0, 15.66, 600);
                    contexto.drawImage(spriteBordeDerecho, 584.34, 0, 15.66, 600);
                    contexto.drawImage(spriteBordeSuperior, 0, 0, 600, 19.11);
                    miRaqueta.dibujarRaqueta();
                    miPelota.dibujarPelota();
                    miRaqueta.dibujarVidas();
                    dibujarBloques();
                    if(insertCoin){
                        contexto.fillStyle="white";
                        contexto.font="30px Common Pixel";
                        contexto.fillText("INSERT COIN (CLICK)", 125, 270);
                        contexto.fillStyle="black";
                    }
                    miPelota.detectaColisiones();
                    if(start){
                        miPelota.moverPelota();
                    }

                    miPelota.estaFuera();
                    miRaqueta.estaViva();

                    if(!reiniciando){
                        requestAnimationFrame(redibuja);
                    }
                }

                function crearBloques(){
                    var posX = 15.66;
                    var posY = 100;

                    for(var i = 0; i < 6; ++i){
                        var color;

                        switch(i){
                            case 0:
                                color = "gray";
                                break;
                            case 1:
                                color = "red";
                                break;
                            case 2:
                                color = "yellow";
                                break;
                            case 3:
                                color = "blue";
                                break;
                            case 4:
                                color = "DeepPink";
                                break;
                            case 5:
                                color = "lime";
                                break;
                        }
        
                        for(var j = 0; j < 13; ++j){
                            if(i==0){
                                bloques[i][j] = new bloque(posX, posY, color, true, 2);
                            }else{
                                bloques[i][j] = new bloque(posX, posY, color, true);
                            }
                            posX += 43.74
                        }
                        posX = 15.66;
                        posY += 20;
                    }
                }

                function dibujarBloques(){
                    for(var i = 0; i < 6; ++i){
                        for(var j = 0; j < 13; ++j){
                            bloques[i][j].dibujarBloque();
                        }
                    }
                }

                function parpadeo(){
                    if(parrafoEncendido){
                        parrafoJugador.style.color = "black";
                        parrafoEncendido = false;
                    }else{
                        parrafoEncendido = true;
                        parrafoJugador.style.color = "white";
                    }
                }

                function reiniciarJuego(){
                    score = 0;

                    parrafoHighScore.innerHTML = highScore;
                    parrafoPuntos.innerHTML = score;

                    clearInterval(temporizadorDecorativo);
                    temporizadorDecorativo = setInterval(parpadeo,1000);
                    parrafoEncendido = true;

                    start = false;
                    insertCoin = true;

                    bloques = [];
                    for (var i = 0; i < 6; ++i) {
                        bloques[i] = new Array(13);
                    }

                    miRaqueta = new raqueta(267, 525);
                    miPelota = new pelota(294,512);

                    crearBloques();

                    setTimeout(reinicio,5000);
                }

                function reinicio(){
                    reiniciando = false;
                    requestAnimationFrame(redibuja);
                }

                function sleep (milisegundos){
                    var start = new Date().getTime();
                    while(new Date().getTime() < start + milisegundos);
                }

                ///////////////////////MAIN///////////////////////////  

                //Variables
                var temporizadorDecorativo = setInterval(parpadeo,1000);
                var parrafoEncendido = true;

                var reiniciando = false;

                var highScore = 0;
                var score = 0;

                parrafoHighScore.innerHTML = highScore;
                parrafoPuntos.innerHTML = score;

                var start = false;
                var insertCoin = true;

                var bloques = [];
                for (var i = 0; i < 6; ++i) {
                    bloques[i] = new Array(13);
                }

                var miRaqueta = new raqueta(267, 525);

                var miPelota = new pelota(294,512);

                crearBloques();

                requestAnimationFrame(redibuja);
            }
        </script>
    </body>
</html>